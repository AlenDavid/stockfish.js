<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="css/chessboard-0.3.0.min.css" />
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/chess.min.js"></script>
    <script src="js/chessboard-0.3.0.min.js"></script>
  </head>
  <body>
    <div id="board" style="width: 400px"></div>
    <textarea id="log" cols="120" rows="10" readonly="true"></textarea>
    <script>
      var game = new Chess();
      var board;
      var stockfish = new Worker('stockfish.js');
      var logArea = document.getElementById('log');
      logArea.value = "";

      function addToLog(str) {
        document.getElementById('log').value += str + "\n";
        logArea.scrollTop = logArea.scrollHeight;
      }

      // do not pick up pieces if the game is over
      // only pick up pieces for White
      var onDragStart = function(source, piece, position, orientation) {
        if (game.game_over() ||
          piece.search(/^b/) !== -1) {
          return false;
        }
      };

      stockfish.onmessage = function(event) {
//        console.log(event.data);
        addToLog('< ' + event.data);
        var match = event.data.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbk])?/);
        if(match) {
          game.move({from: match[1], to: match[2], promotion: match[3]});
          board.position(game.fen());
        }
      };

      function uciCmd(cmd) {
//        console.log(cmd);
        addToLog('> ' + cmd);
        stockfish.postMessage(cmd);
      }

      var onDrop = function(source, target) {
        // see if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: 'q' // NOTE: always promote to a pawn for example simplicity
        });

        // illegal move
        if (move === null) return 'snapback';

        // make random legal move for black
        console.log(game.pgn());
        uciCmd('position fen ' + game.fen());
        uciCmd('go movetime 700');
      };

      // update the board position after the piece snap
      // for castling, en passant, pawn promotion
      var onSnapEnd = function() {
        board.position(game.fen());
      };

      var cfg = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
      };

      var bookRequest = new XMLHttpRequest();
      bookRequest.open('GET', 'book.bin', true);
      bookRequest.responseType = "arraybuffer";
      bookRequest.onload = function(event) {
        if(bookRequest.status == 200) {
          stockfish.postMessage({book: bookRequest.response});
        }
      };
      bookRequest.send(null);

      board = new ChessBoard('board', cfg);
    </script>
  </body>
</html>
